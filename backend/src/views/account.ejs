<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Usuario - GamblinHub</title>
    <link rel="icon" type="image/jpeg" href="/imagenes/favicon.png">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" defer></script>
    <link rel="stylesheet" href="/css/account.css">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js" defer></script>
    <script src="/Js/account.js" defer></script>
    <script src="/Js/cardsGame.js" defer></script>
</head>

<body>

    <div class="container-fluid min-vh-100 d-flex flex-column p-0">

        <!-- Header -->
        <header class="app-dark-bg d-flex justify-content-between align-items-center p-3">
            <div class="fw-bold fs-4">GamblinHub</div>
            <div class="d-flex gap-2">
                <button class="btn btn-header-outline" id="btnHome" onclick="window.location.href='/'">Home</button>
                <button class="btn btn-header-outline" id="btnHome"
                    onclick="window.location.href='/api/users/logout'; window.location.href='logMenu';">Log out</a></li>
            </div>
        </header>

        <div class="row flex-grow-1 g-0">
            <!-- Sidebar -->
            <aside class="col-auto app-dark-bg d-flex flex-column p-3">
                <button class="btn btn-header-primary mb-2 w-100">Cuenta</button>
                <button class="btn btn-header-outline mb-2 w-100"
                    onclick="window.location.href='/subscription'">Subscripción</button>
                <button class="btn btn-header-outline mb-2 w-100"
                    onclick="window.location.href='/settings'">Ajustes</button>
                <button class="btn btn-header-outline mb-2 w-100" onclick="window.location.href='/help'">Ayuda</button>
                <button class="btn btn-header-outline mb-2 w-100" onclick="window.location.href='/faq'">FAQ</button>
            </aside>

            <!-- Main content -->
            <main class="col p-3">
                <div class="row g-4">
                    <!-- Columna izquierda: avatar y formulario -->
                    <div class="col-lg-6">
                        <!-- Avatar único -->
                        <div class="d-flex align-items-start mb-3">
                            <div id="avatarBox" class="avatar me-3">
                                <img id="avatarImg"
                                    src="<%= user?.avatar ? '/avatars/' + user.avatar : '/avatars/default.png' %>"
                                    alt="Foto de perfil" class="img-fluid rounded"
                                    style="width: 100px; height: 100px; object-fit: cover;">
                            </div>
                            <div class="d-flex flex-column gap-2">

                                <!-- Botón cambiar foto -->
                                <button type="button" class="btn btn-dark" data-bs-toggle="modal"
                                    data-bs-target="#avatarModal">
                                    Cambiar foto de perfil
                                </button>

                                <!-- Balance -->
                                <div class="card p-3"
                                    style="background-color:#1a1a1ae0; border:1px solid #333; width:220px;">
                                    <h6 class="mb-1">Balance de la cuenta</h6>
                                    <p class="fs-5 fw-bold text-success mb-0">
                                        € <%= user?.balance?.toFixed(2) %>
                                    </p>
                                </div>

                            </div>
                        </div>

                        <!-- Formulario -->
                        <div class="card p-3 mb-3">
                            <form id="userForm" action="/api/users/update" method="POST">
                                <div class="row align-items-center mb-3">
                                    <label for="userName" class="col-4 col-form-label text-end">Nombre de
                                        usuario</label>
                                    <div class="col-8">
                                        <input id="userName" name="userName" type="text" class="form-control"
                                            value="<%= user?.userName %>" required>
                                        <div class="text-danger small error" id="errorUsername"></div>
                                    </div>
                                </div>

                                <div class="row align-items-center mb-3">
                                    <label for="firstName" class="col-4 col-form-label text-end">Nombre</label>
                                    <div class="col-8">
                                        <input id="firstName" name="nombre" type="text" class="form-control"
                                            value="<%= user?.nombre %>" required>
                                        <div class="text-danger small error" id="errorFirstName"></div>
                                    </div>
                                </div>

                                <div class="row align-items-center mb-3">
                                    <label for="lastName" class="col-4 col-form-label text-end">Apellido</label>
                                    <div class="col-8">
                                        <input id="lastName" name="apellidos" type="text" class="form-control"
                                            value="<%= user?.apellidos %>" required>
                                        <div class="text-danger small error" id="errorLastName"></div>
                                    </div>
                                </div>

                                <div class="row align-items-center mb-3">
                                    <label for="email" class="col-4 col-form-label text-end">Email</label>
                                    <div class="col-8">
                                        <input id="email" name="email" type="email" class="form-control"
                                            value="<%= user?.email %>" required>
                                        <div class="text-danger small error" id="errorEmail"></div>
                                    </div>
                                </div>

                                <div class="row align-items-center mb-3">
                                    <label for="password" class="col-4 col-form-label text-end">Contraseña</label>
                                    <div class="col-8">
                                        <input id="password" name="password" type="password" class="form-control"
                                            autocomplete="new-password" required>
                                        <div class="text-danger small error" id="errorPassword"></div>
                                    </div>
                                </div>

                                <div class="row align-items-center mb-3">
                                    <label for="date" class="col-4 col-form-label text-end">Fecha de nacimiento</label>
                                    <div class="col-8">
                                        <input id="date" name="fechaNacimiento" type="date" class="form-control"
                                            value="<%= new Date(user.fechaNacimiento).toISOString().slice(0,10) %>"
                                            required>
                                        <div class="text-danger small error" id="errorDate"></div>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-end gap-2 mt-3">
                                    <button class="btn btn-header-primary" type="submit">Guardar</button>
                                    <button class="btn btn-header-outline" type="button"
                                        id="btnCancel">Cancelar</button>
                                </div>
                            </form>
                        </div>

                        <button class="btn btn-danger w-100" id="btnDelete">Eliminar cuenta</button>

                    </div>

                    <!-- Columna derecha: canvas -->
                    <div class="col-lg-6">
                        <aside class="CanvasAside card p-3 h-100">
                            <canvas id="userCanvas" width="600" height="350"></canvas>
                            <div id="cardsGameUI" class="mt-3 d-flex flex-column align-items-center">
                                <div class="mb-2 w-100 d-flex justify-content-between align-items-center">
                                    <div class="text-muted">Nivel: <span id="cardsLevel">1</span></div>
                                </div>
                                <div class="d-flex gap-2 w-100">
                                    <button id="btnPlayCards" class="btn btn-header-primary flex-grow-1">Jugar Carta
                                        Tramposa</button>
                                    <button id="btnResetCards" class="btn btn-header-outline">Reiniciar</button>
                                </div>
                                <div id="cardsMsg" class="mt-2 small text-center"
                                    style="min-height:1.2em;color:#f8f9fa"></div>
                            </div>
                        </aside>
                    </div>
                </div>
            </main>
        </div>

        <!-- Modal (snippet) -->
        <div class="modal fade" id="avatarModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content app-dark-bg text-white" style="background-color: #2b3035;">
                    <div class="modal-header border-secondary">
                        <h5 class="modal-title">Elige un Avatar</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row g-3">
                            <% if (avatars && avatars.length> 0) { %>
                                <% avatars.forEach(function(img) { %>
                                    <div class="col-4 col-md-3">
                                        <div class="avatar-option p-1 border border-secondary rounded text-center h-100"
                                            style="cursor: pointer; transition: transform 0.2s;"
                                            onmouseover="this.style.transform='scale(1.05)'"
                                            onmouseout="this.style.transform='scale(1)'"
                                            onclick="selectAvatar('<%= img %>', this)">
                                            <img src="/avatars/<%= img %>" class="img-fluid rounded mb-1">
                                            <div class="small text-truncate">
                                                <%= img %>
                                            </div>
                                        </div>
                                    </div>
                                    <% }); %>
                                        <% } else { %>
                                            <p class="text-center text-muted">No se encontraron avatares en
                                                public/avatars</p>
                                            <% } %>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            function selectAvatar(filename, element) {
                // 1. Limpiar la selección previa
                document.querySelectorAll('.avatar-option').forEach(el => {
                    el.classList.remove('border-primary', 'border-4'); // Quita el borde resaltado
                });

                // 2. Marcar el elemento actual como seleccionado
                element.classList.add('border-primary', 'border-4'); // Añade el borde de selección

                // 3. Update preview image
                document.getElementById('avatarImg').src = '/avatars/' + filename;

                // 4. Update hidden input for the form
                const hidden = document.getElementById('selectedAvatar');
                if (hidden) hidden.value = filename;

                // 5. Close modal (use getOrCreateInstance to avoid null)
                const modalEl = document.getElementById('avatarModal');
                const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                if (modal) modal.hide();
            }
        </script>
        <!-- Footer -->
        <footer class="app-dark-bg text-center p-3 mt-auto">
            <p class="mb-1">Para más información visita <a href="https://www.youtube.com/watch?v=xvFZjo5PgG0"
                    class="text-primary fw-bold">GamblingHub.org</a></p>
            <p class="mb-0 text-secondary">© 2025 GamblinHub</p>
        </footer>

    </div>
</body>

</html>